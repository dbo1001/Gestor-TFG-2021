\apendice{Documentacióncnica de programación}

\section{Introducción}
En esta sección se describe la estructura del proyecto, el proceso de instalación del framework y las herramientas necesarias para desarrollar el trabajo. También se explica cómo realizar la instalación de dependencias, la compilación, la ejecución del proyecto y el despliegue en Heroku.

\section{Estructura de directorios}
Se enumerarán y describirán brevemente los directorios del proyecto. Se puede encontrar el código fuente en el repositorio de Github denominado \href{https://github.com/dbo1001/Gestor-TFG-2021}{``Gestor-TFG-2021''}.

\begin{itemize}
	\item \textbf{/:} directorio raíz donde se ubican el README, el fichero de configuración para el despliegue de \href{https://dashboard.heroku.com/}{Heroku}, los archivos de configuración de Vaadin 14, Spring Boot y Maven. 
	\item \textbf{/.github/workflows} los archivos de \textit{workflow} o flujo de trabajo, tanto para la Integración continua del proyecto en GitHub como para el análisis de la calidad del código en \href{https://sonarcloud.io/}{SonarCloud}.
	\item \textbf{/Documentacion} material de documentación del proyecto y aplicaciones de prueba empleadas.
		\begin{itemize}
			\tightlist
			\item \textbf{/Documentacion/LaTeX} ficheros para generar la memoria y los anexos.
			\item \textbf{/Documentacion/Pruebas} aplicaciones prototipo para comenzar el aprendizaje con \href{https://vaadin.com/}{Vaadin}.
		\end{itemize}
	\item \textbf{/frontend} código encargado del diseño gráfico de la aplicación por el lado del cliente.
	\item \textbf{/src} código \textit{backend} de la aplicación web principal, \textbf{sistinf}.
	\begin{itemize}
		\tightlist
		\item \textbf{/src/main/java/ubu/digit} código fuente en Java de la aplicación web.
			\begin{itemize}
				\item \textbf{/src/main/java/ubu/digit/persistence} código fuente encargado de la conexión y lectura de los ficheros de datos (fachada de datos).
				\item \textbf{/src/main/java/ubu/digit/security} código fuente de conexión y consulta con el moodle de UbuVirtual.
				\item \textbf{/src/main/java/ubu/digit/ui} código en relación a las ventanas y vistas de la aplicación.
				\item \textbf{/src/main/java/ubu/digit/util} incluye los métodos empleados de utilidad empleados en toda la app. 
				\item \textbf{/src/main/java/ubu/digit/webService} servicios web empleados para la consulta en moodle.
			\end{itemize}
		\item \textbf{/src/test} tests unitarios sobre las clases fachada ``SistInfDataCsv'' y ``SistInfDataXls''.
	\end{itemize}
\end{itemize}

\section{Manual del programador}
A continuación se detallará el proceso de instalación de los programas necesarios para el desarrollo de la aplicación.

\subsection{Instalación de Java}

Anteriormente se empleaba Vaadin 8, por lo que se debía emplear la versión Java 8, en concreto se usaba jdk1.8.0\_271. Pero, con la migración a Vaadin 14 se cambió a Java 11.
 
Para ello se debe descargar la \href{https://www.oracle.com/es/java/technologies/javase/jdk11-archive-downloads.html}{página de descargas de Oracle Java SE 11.0} y descargar la versión de JDK 11, correspondiente con el sistema operativo que se posea y su arquitectura, ya sea de 64 o 32 bits. Ver imagen \ref{fig:Descarga_JDK_11}.

Tras escoger la versión según el SO, se leerán y aceptarán las licencias de uso de Oracle \ref{fig:Descarga_JDK11_Licencia}, y se dará a descargar. 
\imagenflotante{Descarga_JDK_11}{Descarga de JDK 11}{0.9}

También se deberá cambiar la variable de entorno de Java del sistema.

\imagenflotante{Descarga_JDK11_Licencia}{Descarga JDK 11 Licencia}{0.9}

\subsection{Instalación de Eclipse}
A continuación se instalará un entorno de desarrollo integrado(IDE) para Java, en este caso se ha utilizado \textbf{Eclipse IDE for Enterprise Java Developers} en la versión 2020-06. 

Para descargar el IDE se accederá a la \href{https://www.eclipse.org/downloads/packages/release/2020-06/r}{página de descargas de Eclipse} y descargar la opción correspondiente a nuestro sistema operativo del \textbf{Eclipse Installer 2020-06 R}. Ver imagen \ref{fig:Descargar_IDE}.

\imagenflotante{Descargar_IDE}{Descargar IDE Eclipse}{0.9}

En el caso de los sistemas operativos Windows se descargará un archivo ejecutable que se deberá ejecutar como administrador. Una vez ejecutado se deberá seleccionar la opción ``\textbf{\textit{Eclipse IDE for Enterprise Java Developers}}'' \ref{fig:Eclipse_Installer}. 

En el siguiente paso, en el apartado de ``\textbf{Java 1.8 + VM}'' se deberá seleccionar la carpeta donde se encuentra el JDK 8, instalado anteriormente \ref{fig:Eclipse_Installer_JDK}.

\imagenflotante{Eclipse_Installer}{Seleccionar Eclipse}{0.9}
\imagenflotante{Eclipse_Installer_JDK}{Seleccionar JDK que usará el IDE}{0.9}

\subsection{Instalación del \textit{plugin de Vaadin} para Eclipse}
Una vez se haya instalado Eclipse, se procederá a añadir el plugin de Vaadin para Eclipse. Esto se realizará mediante el \textbf{Eclipse Marketplace de Eclipse} \ref{fig:Eclipse_marketplace}, el cual se encuentra en la opción de ``\textbf{\textit{Help/Eclipse Marketplace...}}'' de la barra de herramientas.

\imagenflotante{Eclipse_marketplace}{Eclipse marketplace}{0.7}

Una vez en el Eclipse Marketplace, se buscará ``\textbf{Vaadin}'' y se pulsará ``\textbf{Go}''. Tras salir el plugin ``\textbf{\textit{Vaadin Plugin for Eclipse}}'', se dará a ``\textbf{Install}'' y comenzará la instalación del plugin \ref{fig:Plugin_Vaadin}.

\imagenflotante{Plugin_Vaadin}{Plugin Vaadin}{0.9}

\section{Compilación, instalación y ejecución del proyecto}
Se explicará como compilar, instalar y ejecutar el proyecto. En el caso de la ejecución, se detallará como hacerlo desde un terminal y mediante Eclipse (IDE).

\subsection{Descarga del repositorio}
El código fuente se encuentra en el \href{https://github.com/dbo1001/Gestor-TFG-2021}{repositorio del proyecto} en GitHub. Para descargarlo se deberá hacer click en ``\textbf{\textit{Code}}'' y copiar la URL que aparece en el apartado de ``\textbf{HTTP}''. Con esta URL deberemos ir al ``\textbf{GitHub Desktop}'' y clonar el repositorio \ref{fig:GitHub_Code}.

\imagenflotante{GitHub_Code}{Copiar URL repositorio}{0.9}

Si se desea tener código en local se deberá descargar el zip ``\textbf{\textit{Download ZIP}}'' en la opción ``\textbf{\textit{Code}}'' anteriormente mencionada. Una vez descargado el zip se descomprimirá y abrirá con Eclipse. 

Para abrir el proyecto con Eclipse se seleccionará en la barra de herramientas \textbf{\textit{File/Import\dots}}. Aparecerá una ventana en la que se optará por la opción ``\textbf{\textit{Projects from Folder or Archieve}}'' y se hará click en ``\textbf{\textit{Next}}''.

Después se hará click en ``\textbf{\textit{Directory\dots}}'' y se elegirá la carpeta del proyecto con nombre ``\textbf{sistinf}'' y se terminará la importación con ``\textbf{\textit{Finish}}''.
	
\subsection{Ejecución del proyecto}

Para la ejecución del proyecto en local desde terminal se usará:
\begin{itemize}
	\item Limpiar las dependencias: \textbf{``mvn clean''}.
	\item Instalar dependencias y compilar: \textbf{``mvn install''}.
	\item Instalar en modo producción (para desplegar): \textbf{``mvn package -Pproduction''}.  
	\item Ejecutar test: \textbf{``mvn test''}.	
\end{itemize}

Para ejecutar el proyecto a través del IDE de Eclipse se deberá importar como proyecto Maven, con el pom.xml. Se usará un servidor local de \href{https://tomcat.apache.org/download-90.cgi}{Apache Tomcat}, en concreto, la versión 9. Se puede descargar en \href{https://tomcat.apache.org/download-90.cgi}{la página oficial de Apache Tomcat}.

Una vez descargado y descomprimido, se creará un servicio de Tomcat \ref{fig:añadirTomcat} con la ruta donde se tiene descargado Tomcat y se le dará un nombre \ref{fig:nombreServerTomcat}. Por último, se añadirá el proyecto principal ``sistinf'' \ref{fig:tomcatAñadirProyecto}.

\imagenflotante{añadirTomcat}{Añadir servidor de Tomcat a Eclipse}{0.9}
\imagenflotante{nombreServerTomcat}{Seleccionar carpeta contenedora de Tomcat}{0.9}
\imagenflotante{tomcatAñadirProyecto}{Añadir proyectos a servidor}{0.9}

Primero se deberá ejecutarán las dependencias, bien desde comando o desde Eclipse (click derecho en el proyecto>``Run As''>``Maven install'') y después se iniciará el servicio con la opción \emph{start} que aparece en la vista de los servidores. 

Si no aparece la vista de los servicios se puede añadir desde la barra de herramientas>``Window''>``Show View''. Para configurar la ruta donde se ejecuta la aplicación, por defecto en \href{http://localhost:8080/}{localhost:8080/}, y el \emph{timeout}, se hará en el archivo de configuración pulsando doble click sobre el servicio.

\subsection{Despliegue con Heroku}
El proceso de creación de cuenta, instalación y despliegue viene documentado en la \href{https://devcenter.heroku.com/articles/getting-started-with-java}{página oficial de Heroku}.

\subsection{Instalación de Heroku CLI}
Para desplegar la aplicación deberá instalar instalar el cliente de Heroku, Heroku CLI. Se descargará \href{https://devcenter.heroku.com/articles/heroku-cli#download-and-install}{Heroku CLI} según arquitectura Windows de la que se disponga y se ejecutará el instalador obtenido \ref{fig:HerokuCLI}.

\imagenflotante{HerokuCLI}{Descarga Heroku CLI}{0.9}

\subsection{Creación aplicación en Heroku}
Primero se creará una cuenta de Heroku, desde la página de \href{https://dashboard.heroku.com/}{Heroku}. Una vez realizado esto se creará una aplicación de prueba desde la opción ``Creat new app'' \ref{fig:CrearAppHeroku} y se introducirá el nombre que se desee darle a la app \ref{fig:CrearApp2}, finalizando la creación pulsando al botón``Create app'' \ref{fig:CrearApp3}. 

\imagenflotante{CrearAppHeroku}{Crear app en Heroku}{0.9}
\imagenflotante{CrearApp2}{Introducir datos de la nueva app}{0.9}

Se podrá elegir el modo de despliegue a usar entre: GitHub, Heroku Git (localmente con Heroku CLI) o con Container Registry.

\imagenflotante{CrearApp3}{App creada en Heroku}{0.9}

Se intentó realizar el despligue de forma automática empleando Github, pero no se logró, en la \href{https://github.com/dbo1001/Gestor-TFG-2021/issues/112}{issue de Github}, en el apartado ``Despliegue a través de github'', se puede ver el proceso que se realizó en más detalle. Por lo que se empleó el despliegue local. 

Se comenzará por empaquetar el proyecto, para ello se abrirá un terminal en el directorio de nuestro proyecto y se ejecutará el comando \emph{``mvn clean package -Pproduction''}. Con este comando se empaquetará el proyecto, en formato war, en modo producción (\emph{``-Pproduction''}) \ref{fig:Descargar_IDE}.

\imagenflotante{empaquetarWAR}{Despliegue en Heroku - Empaquetar aplicación en .war}{0.9}

Ahora se deberá cambiar la versión de Java en Heroku. Para migrar a Java 11 en Heroku, solamente hará falta incluir un fichero llamado ``system.properties'', donde se especificará la versión: \emph{``java.runtime.version=11''}.

Por último, se ejecuta \emph{``heroku war:deploy target/sistinf-0.5.war --app gestor-tfg-2021''} para desplegar el proyecto en Heroku \ref{fig:Descargar_IDE}. 

\imagenflotante{despliegueHeroku}{Despliegue en Heroku - Realizar despliegue con el war}{0.9}

Para acceder a la aplicación web se puede ejecutar el comando \emph{“heroku open –-app gestor-tfg-2021”} en la consola o a través del siguiente enlace \href{https://gestor-tfg-2021.herokuapp.com/}{https://gestor-tfg-2021.herokuapp.com/}. Otra opción, aunque únicamente se podría hacer si se conoce los credenciales de la cuenta de Heroku, es a través de la página del apartado donde 

Para ver los mensajes internos de la aplicación (\emph{logs}) se deberá ejecutar el comando \emph{``heroku logs --tail --app gestor-tfg-2021''}

\section{Pruebas del sistema}

Para verificar el funcionamiento de algunas de las funciones principales para la obtención de datos de los ficheros se realizaron test de \href{https://junit.org/junit5/}{JUnit}. Al haber dos clases fachada, una para cada tipo de fichero, se decidió separar la clase existente, procedente de la versión anterior, en dos, ``SistInfDataTestCSV'' y ''SistInfDataTestXLS''. Para ejecutar los test se puede realizar el comando ``mvn test''.

Se ejecutaron los test cada vez que se realizaba una modificación mediante la integración Continua en \href{https://github.com/dbo1001/Gestor-TFG-2021/actions}{GitHub Actions} consiguiendo detectar errores con mayor rapidez.